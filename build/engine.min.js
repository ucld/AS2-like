"use strict";function a(){this.files={},this.loadFile=function(t,e,i){if(this.files[t])i(this.files[t].obj);else{const s=this;this.files[t]={obj:new e,loaded:!1},this.files[t].obj.src=t,this.files[t].obj.onload=function(){s.files[t].loaded=!0,i(s.files[t].obj)}}},this.getFile=function(t){return this.files[t]&&this.files[t].loaded?this.files[t].obj:null}}function b(){function t(t,e,...i){const s=[...i.map(t=>new RegExp(t)),/./].filter(e=>e.test(t))[0],n=t.match(s).slice(1).map(t=>e(t));return n.length&&n.every(t=>t<256)?n:null}this.isRGB=function(e){const i="\\s*?([0-9]+)\\s*?";return t(e,t=>+t,"^rgb\\("+i+","+i+","+i+"\\)$","^rgba\\("+i+","+i+","+i+","+i+"\\)$")},this.isHex=function(e){const i="([0-9A-Fa-f])",s="([0-9A-Fa-f]{2})";return t(e,t=>1===t.length?parseInt(t+t,16):parseInt(t,16),"^#"+s+s+s+s+"$","^#"+s+s+s+"$","^#"+i+i+i+"$")}}const c=new a,d=new b;function e(t){function e(t,e,i){return t<e?e:t>i?i:t}function i(i){i.type.includes("touch")&&(i.preventDefault(),i=i.changedTouches[0]);let s=t.offsetWidth,n=t.offsetHeight,h=t.offsetLeft,o=t.offsetTop;document.fullscreen&&(t.offsetWidth>t.offsetHeight?(o=0,n=t.offsetHeight,s=t.width*(t.offsetHeight/t.height),h=(t.offsetWidth-s)/2):(h=0,s=t.offsetWidth,n=t.height*(t.offsetWidth/t.width),o=(t.offsetHeight-n)/2));const r=e(Math.floor((i.clientX-h+window.scrollX)*t.width/s),0,t.width),u=e(Math.floor((i.clientY-o+window.scrollY)*t.height/n),0,t.height);this.mouse.x=r,this.mouse.y=u,this.triggers.mousemove=1}function s(t){"keydown"===t.type?this.keybd.down[t.key]=!0:"keyup"===t.type&&(this.keybd.down[t.key]=!1),this.keybd.active=!0,this.triggers[t.type]=t.key}this.triggers={},this.mouse={x:0,y:0},this.keybd={down:{},current:null},t.addEventListener("touchmove",i.bind(this)),t.addEventListener("mousemove",i.bind(this)),t.addEventListener("wheel",i.bind(this)),document.addEventListener("keypress",s.bind(this)),document.addEventListener("keydown",s.bind(this)),document.addEventListener("keyup",s.bind(this)),document.addEventListener("keydown",function(e){const i=this.keybd.down.Alt&&this.keybd.down.Enter;i&&!document.fullscreen?t.requestFullscreen():i&&document.fullscreen&&document.exitFullscreen()}.bind(this));const n=["click","wheel","mouseup","mousedown","keypress","keydown","keyup"],h={click:["touchstart"],mousedown:["touchstart"],mouseup:["touchend"]};for(const e in n){const i=n[e],s=function(){this.triggers[i]=1}.bind(this);if(t.addEventListener(i,s),h[i])for(const e in h[i])t.addEventListener(h[i][e],s)}this.triggerSprite=function(t,e,i){const s=this.mouse.x,n=this.mouse.y;if(s>=e&&s<=e+t._w&&n>=i&&n<=i+t._h)for(const e in t._events.mouse)this.triggers[e]&&t._events.mouse[e].bind(t)(s,n);if(this.keybd.active)for(const e in t._events.keybd)this.triggers[e]&&t._events.keybd[e].bind(t)(this.triggers[e])},this.resetTriggers=function(){for(const t in this.triggers)"active"!==t&&(this.triggers[t]=0);this.keybd.active=!1}}function f(t,i,s){const n=window.AudioContext||window.webkitAudioContext;Object.assign(this,{ctx:t.getContext("2d"),evt:new e(t),sfx:new n,width:i,height:s,speed:24}),t.width=i,t.height=s,t.style.cssText="image-rendering: -moz-crisp-edges;image-rendering: -webkit-crisp-edges;image-rendering: pixelated;",this.ctx.imageSmoothingEnabled=!1,this.getVP=new Array(2),this.setVP=function(t,e,i,s){const n=t<i,h=t>=s||e<i,o=e<s;this.getVP.length=2,h?this.getVP.length=0:n&&o?(this.getVP[0]=i,this.getVP[1]=e-i):n&&!o?(this.getVP[0]=i,this.getVP[1]=s-i):!n&&o?(this.getVP[0]=t,this.getVP[1]=e-t):n||o?this.getVP.length=0:(this.getVP[0]=t,this.getVP[1]=s-t)},this.clearFrame=function(){this.ctx.clearRect(0,0,this.width,this.height)},this.setAlpha=function(t){this.ctx.globalAlpha=t},this.drawRect=function(t,e,i,s,n){let h,o,r,u;this.setVP(e,e+s,0,this.width),this.getVP.length&&(h=this.getVP[0],o=this.getVP[1]),this.setVP(i,i+n,0,this.height),this.getVP.length&&(r=this.getVP[0],u=this.getVP[1]),isNaN(h+o+r+u)||(this.ctx.fillStyle=t,this.ctx.fillRect(h,r,o,u))},this.drawImage=function(t,e,i,s,n,h,o,r,u){let d,a,l,f;const _=c.getFile(t);this.setVP(e,e+s,0,this.width),this.getVP.length&&(d=this.getVP[0],a=this.getVP[1]),this.setVP(i,i+n,0,this.height),this.getVP.length&&(l=this.getVP[0],f=this.getVP[1]),_&&!isNaN(d+a+l+f)&&this.ctx.drawImage(_,h+(d-e),o+(l-i),a,f,d,l,a,f)},this.drawSprite=function(t,e,i,s,n,h){const o=t._frames[t._frame],r=t._actions[t._frame];t._children=o,t._parent=h,t._root=n,this.setAlpha(t._alpha*s);for(const t in o){const r=o[t];if("sprite"===r._render)this.drawSprite(r,r._x+e,r._y+i,r._alpha*s,n,h);else if("rect"===r._render)this.drawRect(r._string,r._x+e,r._y+i,r._w,r._h);else if("image"===r._render)this.drawImage(r._src,r._x+e,r._y+i,r._w,r._h,r._sx,r._sy,r._sw,r._sh);else if("audio"===r._render){const t=c.getFile(r._src);t.ctx=this.sfx,r._loop=r._parent._loop,r._volume=r._parent._volume,t.loop=r._parent._loop,t.volume=r._parent._volume,!t.bindedSprite!==r._parent&&(t.bindedSprite=r._parent,t.onended=function(){r._parent._paused=!0}),t.paused!==r._parent._paused&&(t.paused?t.play():t.pause(),r._paused=r._parent._paused)}}n&&t!==n&&this.evt.triggerSprite(t,e,i),t._events.enterFrame&&t._events.enterFrame.bind(t)(),r&&(Array.isArray(o)?r.bind(t)(...o):r.bind(t)({_children:o,...o,_parent:h,_root:n})),!t._paused&&t._frames.length>0&&t.nextFrame()},this.renderSprite=function(t){t&&!this.sprite&&(t._root=t,t.mouse={_x:0,_y:0},t.key=this.evt.keybd.down,this.sprite=t,this.lastTime=0);const e=this.lastTime,i=1e3/this.speed,s=performance.now(),n=s-e;n>i&&(this.clearFrame(),this.lastTime=s-n%i,this.sprite.mouse._x=this.evt.mouse.x,this.sprite.mouse._y=this.evt.mouse.y,this.drawSprite(this.sprite,0,0,1,this.sprite),this.evt.resetTriggers()),requestAnimationFrame(this.renderSprite.bind(this))}}function g(){function t(){this.audioGainSource=this.ctx.createGain(),this.audioBufferSource=this.ctx.createBufferSource(),this.audioBufferSource.onended=function(){this.paused=!0,this.ended=!0,this.onended&&this.onended()}.bind(this);const t=new ArrayBuffer(this.buffer.byteLength);new Uint8Array(t).set(new Uint8Array(this.buffer)),this.ctx.decodeAudioData(t,function(t){this.audioBufferSource.buffer=t,this.audioBufferSource.loop=this._loop,this.audioBufferSource.start(0,0),this.audioBufferSource.connect(this.audioGainSource),this.audioGainSource.connect(this.ctx.destination),this.audioGainSource.gain.value=this._volume}.bind(this))}this.ctx=null,this.buffer=null,this.bindedSprite=null,this.audioBufferSource=null,this.audioGainSource=null,this.paused=!0,this.ended=!1,this.onended=!1,this._src=null,this._onload=null,this._volume=1,this._loop=!1;const e=function(){this.ctx.unlocked=!0,t.bind(this)(),document.removeEventListener("mousedown",e),document.removeEventListener("touchstart",e)}.bind(this);this.play=function(){!this.audioBufferSource||this.ended?(this.ended=!1,this.paused=!1,this.ctx.unlocked?t.bind(this)():(document.addEventListener("mousedown",e),document.addEventListener("touchstart",e))):this.paused&&this.ctx.resume().then(function(){this.paused=!1}.bind(this))},this.pause=function(){"running"===this.ctx.state&&this.ctx.suspend().then(function(){this.paused=!0}.bind(this))}}function h(t,e,i,s,n,h,o,r,u){this._x=e,this._y=i,this._w=s,this._h=n,this._sx=h,this._sy=o,this._sw=r,this._sh=u,this._src=t,this._parent=null,this._render="image"}function i(t){this._loop=!1,this._paused=!1,this._volume=1,this._src=t,this._parent=null,this._render="audio"}function j(t,e,i,s,n){this._x=e,this._y=i,this._w=s,this._h=n,this._parent=null,this._string=null,this._shape=t,this._render="rect"}function Sprite(t,e,s,n,o){this._x=e,this._y=s,this._w=n,this._h=o,this._alpha=1,this._frame=0,this._frames=[],this._actions=[],this._children=[],this._parent=null,this._root=null,this._origin=0,this._render="sprite",this._paused=!1,this._events={enterFrame:null,mouse:{}},this.stop=function(){return this._paused=!0,this},this.play=function(){return this._paused=!1,this},this.nextFrame=function(){return this._frame=(this._frame+1)%this._frames.length,this},this.gotoFrame=function(t){return this._frame=t%this._frames.length,this},this.addToFrame=function(t,e){for(const t in e)e[t]._parent=this;if(t<0||t>=this._frames.length)this._frames.push(e);else{const i=Array.isArray(this._frames[t]),s=Array.isArray(e);i!==s||!i&&!s?this._frames[t]={...this._frames[t],...e}:i&&(this._frames[t]=[...this._frames[t],...e])}return this},this.addFrame=function(t){for(const e in t)t[e]._parent=this;return this.addToFrame(this._frames.length,t),this},this.addToAction=function(t,e){t<0||t>=this._frames.length?this._actions.push(e):this._actions[t]=e},this.addAction=function(t){return this.addToAction(this._frames.length,t),this},this.renderTo=function(t,e){return new f(t,this._w,this._h).renderSprite(this),this},this.onEnterFrame=function(t){return this._events.enterFrame=t,this};const r={mouse:["MouseMove","MouseDown","MouseUp","Click"],keybd:["KeyDown","KeyUp","KeyPress"]};for(const t in r){this._events[t]||(this._events[t]={});for(const e in r[t])this["on"+r[t][e]]=function(i){return this._events[t][r[t][e].toLowerCase()]=i,this}}const u=t.length>=3?t.substr(-3):"";if(d.isHex(t)||d.isRGB(t)){const e=new j("rect",0,0,n,o);e._parent=this,e._color=t,this.addFrame([e])}else if(["mp3","wav","ogg"].includes(u)){const e=this;this._loop=!0,this._volume=1,c.loadFile(t,g,function(s){e.addFrame([new i(t)])})}else if(["jpg","jpeg","gif","png","bmp"].includes(u)){const e=this;c.loadFile(t,Image,function(i){const s=i.width/e._w,n=i.height/e._h,o=s*n;if(n%1==0&&s%1==0)for(let i=0,n=0,r=0;i<o;i++){n=i%s,r=Math.floor(i/s);const o=new h(t,0,0,e._w,e._h,n*e._w,r*e._h,e._w,e._h);o._parent=e,e.addFrame({_src:o})}else{const i=new h(t,0,0,e._w,e._h,0,0,e._w,e._h);i._parent=e,e.addFrame([i])}})}else"_clip_"!==t&&console.error("Source Error: "+t)}function Clip(t,e,i,s){Sprite.call(this,"_clip_",t,e,i,s)}function AudioClip(t){Sprite.call(this,t,0,0,0,0)}g.prototype={set src(t){return this._src=t,fetch(new Request(t)).then(function(t){return t.arrayBuffer()}).then(function(t){this.buffer=t,this._onload&&this._onload()}.bind(this)),t},get src(){return this._src},set onload(t){return this._onload=t,this._onload},get onload(){return this._onload},set volume(t){return this.audioGainSource&&(this.audioGainSource.gain.value=t),this._volume=t,t},get volume(){return this._volume},set loop(t){return this.audioBufferSource&&(this.audioBufferSource.loop=t),this._loop=t,t},get loop(){return this._loop}},j.prototype={get _color(){return d.isHex(this._string)||d.isRGB(this._string)},set _color(t){const e=d.isHex(t)||d.isRGB(t);this._parent&&(this._parent._alpha=e.length>3?e[3]/255:1),this._string="rgb("+e.slice(0,3)}};